<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>60-Day Campaign Overview - Signals & Actions</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles/swiss-design.css">
    <style>
        /* Integrate with existing design system */
        .page-with-sidebar {
            margin-left: 250px;
            transition: margin-left 0.3s ease;
        }
        
        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .page-header {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 300;
            margin: 0 0 0.5rem 0;
        }
        
        .page-subtitle {
            color: #666;
            font-size: 0.875rem;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: #1976d2;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .section-title i {
            color: #1976d2;
            font-size: 1.25rem;
        }
        
        .campaigns-grid {
            display: grid;
            gap: 1rem;
        }
        
        .campaign-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            background: #f8f9fa;
            transition: all 0.2s;
        }
        
        .campaign-card:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .campaign-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .campaign-name {
            font-weight: 500;
            font-size: 1.125rem;
            color: #1a1a1a;
        }
        
        .campaign-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-active {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-paused {
            background: #fff3e0;
            color: #e65100;
        }
        
        .status-draft {
            background: #e0e0e0;
            color: #666;
        }
        
        .campaign-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .metric {
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: #666;
        }
        
        .top-list {
            display: grid;
            gap: 0.75rem;
        }
        
        .top-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: background 0.2s;
        }
        
        .top-item:hover {
            background: #e8f5e9;
        }
        
        .item-name {
            font-weight: 500;
            color: #1a1a1a;
            flex: 1;
        }
        
        .item-name a {
            color: inherit;
            text-decoration: none;
        }
        
        .item-name a:hover {
            color: #1976d2;
        }
        
        .item-count {
            background: #1976d2;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .posts-grid {
            display: grid;
            gap: 1rem;
        }
        
        .post-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
            transition: all 0.2s;
        }
        
        .post-card:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .post-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #1a1a1a;
        }
        
        .post-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: #666;
        }
        
        .post-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: #666;
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .error {
            color: #d32f2f;
            padding: 1rem;
            background: #ffebee;
            border-radius: 4px;
            margin: 1rem 0;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 768px) {
            .page-with-sidebar {
                margin-left: 0;
            }
            
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .campaign-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body class="has-sidebar page-with-sidebar">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title">60-Day Campaign Overview</h1>
            <div class="page-subtitle" id="date-range">Loading date range...</div>
        </div>
        
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="total-campaigns">0</div>
                <div class="stat-label">Active Campaigns</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-impressions">0</div>
                <div class="stat-label">Total Impressions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-clicks">0</div>
                <div class="stat-label">Total Clicks</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-spend">$0</div>
                <div class="stat-label">Total Spend</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-ctr">0%</div>
                <div class="stat-label">Average CTR</div>
            </div>
        </div>
        
        <!-- Campaigns Section -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-bullhorn"></i>
                Recent Campaigns
            </h2>
            <div id="campaigns-container" class="campaigns-grid">
                <div class="loading">
                    <i class="fas fa-spinner loading-spinner"></i>
                    Loading campaigns...
                </div>
            </div>
        </div>
        
        <!-- Top Companies and Titles -->
        <div class="two-column">
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-building"></i>
                    Top Companies
                </h2>
                <div id="top-companies" class="top-list">
                    <div class="loading">
                        <i class="fas fa-spinner loading-spinner"></i>
                        Loading companies...
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-briefcase"></i>
                    Top Job Titles
                </h2>
                <div id="top-titles" class="top-list">
                    <div class="loading">
                        <i class="fas fa-spinner loading-spinner"></i>
                        Loading titles...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top People -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-users"></i>
                Most Engaged People
            </h2>
            <div id="top-people" class="top-list">
                <div class="loading">
                    <i class="fas fa-spinner loading-spinner"></i>
                    Loading people...
                </div>
            </div>
        </div>
        
        <!-- Recent Posts -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-file-alt"></i>
                Recent Posts
            </h2>
            <div id="posts-container" class="posts-grid">
                <div class="loading">
                    <i class="fas fa-spinner loading-spinner"></i>
                    Loading posts...
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="services/urn-decoder.js"></script>
    <script>
        // Real post mappings from user
        const APIFY_RUN_MAPPINGS = [
            { runId: 'butuMDGrIRxOxee09', postUrl: null, description: 'Post 1' },
            { runId: 'JqrdZuVDQz9AgQIIU', postUrl: null, description: 'Post 2' },
            { runId: '3nlSqHwyJiQPsoqAC', postUrl: null, description: 'Post 3' },
            { runId: 'PvNvNkbqvWNpaXiD8', postUrl: null, description: 'Post 4' },
            { runId: 'hhHrpS4sCKvBjIsta', postUrl: null, description: 'Post 5' },
            { runId: 'uBCxynShX9JejO2P2', postUrl: null, description: 'Post 6' },
            { runId: 'oxzLwXzLwyICuw85w', postUrl: null, description: 'Post 7' },
            { runId: 'dLF3uRnLs6nWStFGk', postUrl: null, description: 'Post 8' },
            { runId: 'TWcaUmKsvJNO6Qf6Y', postUrl: null, description: 'Post 9' },
            { runId: 'j56hR3kcejjgjhWcE', postUrl: null, description: 'Post 10' }
        ];
        
        // Data state
        const data = {
            campaigns: [],
            companies: {},
            titles: {},
            people: {},
            posts: [],
            engagements: []
        };
        
        // Initialize
        async function init() {
            console.log('Initializing 60-day campaign overview...');
            
            // Load sidebar
            loadSidebar();
            
            // Set date range
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 60);
            
            document.getElementById('date-range').textContent = 
                `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
            
            // Load all data
            await Promise.all([
                loadVuckoCampaigns(),
                loadApifyData()
            ]);
            
            // Render all sections
            renderStats();
            renderCampaigns();
            renderTopCompanies();
            renderTopTitles();
            renderTopPeople();
            renderPosts();
        }
        
        // Load sidebar
        function loadSidebar() {
            fetch('components/sidebar.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('sidebar-container').innerHTML = html;
                })
                .catch(error => console.error('Error loading sidebar:', error));
        }
        
        // Load campaigns from LinkedIn API (Vucko account)
        async function loadVuckoCampaigns() {
            try {
                // Use Vucko account ID: 510508147
                const response = await fetch('http://localhost:8001/api/linkedin/accounts/510508147/campaigns');
                const result = await response.json();
                
                if (result.success && result.campaigns) {
                    console.log(`Total campaigns found: ${result.campaigns.length}`);
                    
                    // Get all campaigns for Vucko
                    data.campaigns = result.campaigns;
                    
                    console.log(`Processing ${data.campaigns.length} Vucko campaigns`);
                    
                    // Load analytics for each campaign
                    await loadCampaignAnalytics();
                } else {
                    console.error('Failed to load campaigns:', result);
                    showError('campaigns-container', 'Failed to load campaigns');
                }
            } catch (error) {
                console.error('Error loading campaigns:', error);
                showError('campaigns-container', 'Failed to load campaigns: ' + error.message);
            }
        }
        
        // Load analytics and demographics for campaigns
        async function loadCampaignAnalytics() {
            const analyticsPromises = data.campaigns.slice(0, 20).map(async (campaign) => {
                try {
                    // Get analytics with proper date range
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 60);
                    
                    const dateRange = `dateRange=(start:(year:${startDate.getFullYear()},month:${startDate.getMonth() + 1},day:${startDate.getDate()}),end:(year:${endDate.getFullYear()},month:${endDate.getMonth() + 1},day:${endDate.getDate()}))`;
                    
                    const analyticsRes = await fetch(`http://localhost:8001/api/linkedin/campaigns/${campaign.id}/analytics?${dateRange}`);
                    const analyticsData = await analyticsRes.json();
                    
                    if (analyticsData.success && analyticsData.analytics?.length > 0) {
                        campaign.analytics = analyticsData.analytics[0];
                    } else {
                        campaign.analytics = { impressions: 0, clicks: 0, spend: 0 };
                    }
                    
                    // Get demographics
                    const demoRes = await fetch(`http://localhost:8001/api/linkedin/campaigns/${campaign.id}/demographics`);
                    const demoData = await demoRes.json();
                    
                    if (demoData.success && demoData.demographics) {
                        campaign.demographics = demoData.demographics;
                        
                        // Aggregate company data
                        if (demoData.demographics.MEMBER_COMPANY) {
                            demoData.demographics.MEMBER_COMPANY.forEach(item => {
                                if (item.name && item.impressions) {
                                    data.companies[item.name] = (data.companies[item.name] || 0) + item.impressions;
                                }
                            });
                        }
                        
                        // Aggregate title data
                        if (demoData.demographics.MEMBER_JOB_TITLE) {
                            demoData.demographics.MEMBER_JOB_TITLE.forEach(item => {
                                if (item.name && item.impressions) {
                                    data.titles[item.name] = (data.titles[item.name] || 0) + item.impressions;
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error(`Error loading data for campaign ${campaign.id}:`, error);
                }
            });
            
            await Promise.all(analyticsPromises);
            console.log('Analytics loaded for campaigns');
        }
        
        // Load Apify engagement data
        async function loadApifyData() {
            console.log('Loading Apify data...');
            
            for (const mapping of APIFY_RUN_MAPPINGS) {
                try {
                    const runRes = await fetch(`https://api.apify.com/v2/actor-runs/${mapping.runId}?token=${APIFY_CONFIG.token}`);
                    const runData = await runRes.json();
                    
                    if (runData.data?.defaultDatasetId) {
                        const datasetRes = await fetch(`https://api.apify.com/v2/datasets/${runData.data.defaultDatasetId}/items?token=${APIFY_CONFIG.token}`);
                        const items = await datasetRes.json();
                        
                        // Get post info from run data
                        const postUrl = runData.data?.input?.startUrls?.[0]?.url || mapping.postUrl;
                        const postTitle = mapping.description;
                        
                        // Store post data
                        data.posts.push({
                            title: postTitle,
                            url: postUrl,
                            engagements: items.length,
                            uniquePeople: new Set(items.map(i => i.profileUrl)).size,
                            runId: mapping.runId
                        });
                        
                        // Process engagements
                        items.forEach(item => {
                            if (item.name && item.headline) {
                                // Track person
                                const personKey = `${item.name}|${item.profileUrl}`;
                                if (!data.people[personKey]) {
                                    data.people[personKey] = {
                                        name: item.name,
                                        headline: item.headline,
                                        profileUrl: item.profileUrl,
                                        engagements: 0,
                                        company: extractCompany(item.headline),
                                        title: extractTitle(item.headline)
                                    };
                                }
                                data.people[personKey].engagements++;
                                
                                // Track company
                                const company = extractCompany(item.headline);
                                if (company) {
                                    data.companies[company] = (data.companies[company] || 0) + 1;
                                }
                                
                                // Track title
                                const title = extractTitle(item.headline);
                                if (title) {
                                    data.titles[title] = (data.titles[title] || 0) + 1;
                                }
                            }
                        });
                        
                        data.engagements.push(...items);
                    }
                } catch (error) {
                    console.error(`Error loading Apify run ${mapping.runId}:`, error);
                }
            }
            
            console.log(`Loaded ${data.posts.length} posts with ${data.engagements.length} total engagements`);
        }
        
        // Extract company from headline
        function extractCompany(headline) {
            if (!headline) return null;
            
            const patterns = [
                / at (.+?)(?:\s*\||$)/i,
                / @ (.+?)(?:\s*\||$)/i,
                /\| (.+?)$/i
            ];
            
            for (const pattern of patterns) {
                const match = headline.match(pattern);
                if (match && match[1]) {
                    return match[1].trim();
                }
            }
            
            return null;
        }
        
        // Extract title from headline
        function extractTitle(headline) {
            if (!headline) return null;
            
            const parts = headline.split(/\s+(?:at|@|\|)\s+/i);
            return parts[0] ? parts[0].trim() : null;
        }
        
        // Render functions
        function renderStats() {
            // Only count campaigns with impressions > 0 as "active"
            const activeCampaigns = data.campaigns.filter(c => c.analytics?.impressions > 0);
            const totalImpressions = data.campaigns.reduce((sum, c) => sum + (c.analytics?.impressions || 0), 0);
            const totalClicks = data.campaigns.reduce((sum, c) => sum + (c.analytics?.clicks || 0), 0);
            const totalSpend = data.campaigns.reduce((sum, c) => sum + (c.analytics?.spend || 0), 0);
            const avgCTR = totalImpressions > 0 ? ((totalClicks / totalImpressions) * 100).toFixed(2) : 0;
            
            document.getElementById('total-campaigns').textContent = activeCampaigns.length;
            document.getElementById('total-impressions').textContent = formatNumber(totalImpressions);
            document.getElementById('total-clicks').textContent = formatNumber(totalClicks);
            document.getElementById('total-spend').textContent = `$${formatNumber(totalSpend)}`;
            document.getElementById('avg-ctr').textContent = `${avgCTR}%`;
        }
        
        function renderCampaigns() {
            const container = document.getElementById('campaigns-container');
            
            // Filter campaigns with data
            const campaignsWithData = data.campaigns
                .filter(c => c.analytics?.impressions > 0)
                .sort((a, b) => (b.analytics?.impressions || 0) - (a.analytics?.impressions || 0))
                .slice(0, 10);
            
            if (campaignsWithData.length === 0) {
                container.innerHTML = '<p>No campaigns with data found in the last 60 days</p>';
                return;
            }
            
            container.innerHTML = campaignsWithData.map(campaign => {
                const statusClass = campaign.status === 'ACTIVE' ? 'status-active' : 
                                  campaign.status === 'PAUSED' ? 'status-paused' : 'status-draft';
                
                return `
                    <div class="campaign-card">
                        <div class="campaign-header">
                            <div class="campaign-name">${campaign.name || 'Untitled Campaign'}</div>
                            <div class="campaign-status ${statusClass}">
                                ${campaign.status || 'UNKNOWN'}
                            </div>
                        </div>
                        <div class="campaign-metrics">
                            <div class="metric">
                                <div class="metric-value">${formatNumber(campaign.analytics?.impressions || 0)}</div>
                                <div class="metric-label">Impressions</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${formatNumber(campaign.analytics?.clicks || 0)}</div>
                                <div class="metric-label">Clicks</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${campaign.analytics?.impressions > 0 ? 
                                    ((campaign.analytics.clicks / campaign.analytics.impressions) * 100).toFixed(2) : 0}%</div>
                                <div class="metric-label">CTR</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">$${formatNumber(campaign.analytics?.spend || 0)}</div>
                                <div class="metric-label">Spend</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderTopCompanies() {
            const container = document.getElementById('top-companies');
            
            const topCompanies = Object.entries(data.companies)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (topCompanies.length === 0) {
                container.innerHTML = '<p>No company data available</p>';
                return;
            }
            
            container.innerHTML = topCompanies.map(([company, count]) => `
                <div class="top-item">
                    <div class="item-name">${company}</div>
                    <div class="item-count">${count}</div>
                </div>
            `).join('');
        }
        
        function renderTopTitles() {
            const container = document.getElementById('top-titles');
            
            const topTitles = Object.entries(data.titles)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (topTitles.length === 0) {
                container.innerHTML = '<p>No title data available</p>';
                return;
            }
            
            container.innerHTML = topTitles.map(([title, count]) => `
                <div class="top-item">
                    <div class="item-name">${title}</div>
                    <div class="item-count">${count}</div>
                </div>
            `).join('');
        }
        
        function renderTopPeople() {
            const container = document.getElementById('top-people');
            
            const topPeople = Object.values(data.people)
                .sort((a, b) => b.engagements - a.engagements)
                .slice(0, 15);
            
            if (topPeople.length === 0) {
                container.innerHTML = '<p>No people data available</p>';
                return;
            }
            
            container.innerHTML = topPeople.map(person => `
                <div class="top-item">
                    <div class="item-name">
                        ${person.profileUrl ? 
                            `<a href="${person.profileUrl}" target="_blank">
                                ${person.name} - ${person.title || 'N/A'} ${person.company ? `at ${person.company}` : ''}
                            </a>` : 
                            `${person.name} - ${person.title || 'N/A'} ${person.company ? `at ${person.company}` : ''}`
                        }
                    </div>
                    <div class="item-count">${person.engagements}</div>
                </div>
            `).join('');
        }
        
        function renderPosts() {
            const container = document.getElementById('posts-container');
            
            if (data.posts.length === 0) {
                container.innerHTML = '<p>No post data available</p>';
                return;
            }
            
            container.innerHTML = data.posts.map(post => `
                <div class="post-card">
                    <div class="post-title">${post.title}</div>
                    <div class="post-meta">
                        <span><i class="fas fa-users"></i> ${post.engagements} engagements</span>
                        <span><i class="fas fa-user"></i> ${post.uniquePeople} unique people</span>
                        ${post.url ? `
                            <a href="${post.url}" target="_blank" style="color: #1976d2;">
                                <i class="fas fa-external-link-alt"></i> View on LinkedIn
                            </a>
                        ` : `
                            <span style="color: #999;">
                                <i class="fas fa-info-circle"></i> Run ID: ${post.runId.slice(0, 8)}...
                            </span>
                        `}
                    </div>
                </div>
            `).join('');
        }
        
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toLocaleString();
        }
        
        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="error">${message}</div>`;
            }
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>