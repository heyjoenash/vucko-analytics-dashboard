<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Detail - Signals & Actions</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/styles/swiss-minimal.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">Signals & Actions</h1>
                <p class="sidebar-subtitle">Vucko</p>
            </div>
            
            <div class="nav-group">
                <div class="nav-label">Overview</div>
                <a href="/index.html" class="nav-link">
                    <i class="fas fa-chart-line nav-icon"></i>
                    Dashboard
                </a>
                <a href="/signals.html" class="nav-link">
                    <i class="fas fa-signal nav-icon"></i>
                    Signals
                </a>
                <a href="/actions.html" class="nav-link">
                    <i class="fas fa-tasks nav-icon"></i>
                    Actions
                </a>
                <a href="/weekly-report.html" class="nav-link">
                    <i class="fas fa-calendar nav-icon"></i>
                    Weekly Report
                </a>
            </div>
            
            <div class="nav-group">
                <div class="nav-label">Content</div>
                <a href="/content-calendar.html" class="nav-link">
                    <i class="fas fa-calendar-alt nav-icon"></i>
                    Content Calendar
                </a>
                <a href="/content-database.html" class="nav-link">
                    <i class="fas fa-database nav-icon"></i>
                    Content Database
                </a>
            </div>
            
            <div class="nav-group">
                <div class="nav-label">Campaigns</div>
                <a href="/audiences.html" class="nav-link">
                    <i class="fas fa-users nav-icon"></i>
                    Audiences
                </a>
                <a href="/campaigns.html" class="nav-link">
                    <i class="fas fa-bullhorn nav-icon"></i>
                    Campaigns
                </a>
            </div>
            
            <div class="nav-group">
                <div class="nav-label">Contacts</div>
                <a href="/people.html" class="nav-link">
                    <i class="fas fa-user nav-icon"></i>
                    People
                </a>
                <a href="/companies.html" class="nav-link">
                    <i class="fas fa-building nav-icon"></i>
                    Companies
                </a>
            </div>
            
            <div class="nav-group">
                <div class="nav-label">Strategy</div>
                <a href="/personas.html" class="nav-link">
                    <i class="fas fa-users nav-icon"></i>
                    Personas
                </a>
            </div>
            
            <div class="nav-group">
                <div class="nav-label">Data Import</div>
                <a href="/import-data.html" class="nav-link">
                    <i class="fas fa-upload nav-icon"></i>
                    Import Data
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <header class="page-header">
                <h1 class="page-title">Campaign Detail</h1>
            </header>

            <div class="detail-container">
                <!-- Campaign Header -->
                <div class="detail-header">
                    <div>
                        <h2 class="font-semibold" style="font-size: var(--font-size-xl);" id="campaign-name">Loading...</h2>
                        <p class="text-muted text-small" id="campaign-client">--</p>
                        <p class="text-muted text-small" id="campaign-dates">--</p>
                    </div>
                    <span class="badge" id="campaign-status">--</span>
                </div>

                <!-- Detail Grid -->
                <div class="detail-grid">
                    <!-- Left Column -->
                    <div>
                        <!-- Overview Section -->
                        <div class="detail-section">
                            <h3 class="section-title">Overview</h3>
                            <div class="metric-row">
                                <span class="metric-label">Campaign Type</span>
                                <span class="metric-value" id="campaign-type">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Budget</span>
                                <span class="metric-value" id="campaign-budget">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Total Spend</span>
                                <span class="metric-value" id="campaign-spend">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Posts</span>
                                <span class="metric-value" id="campaign-posts">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">People Reached</span>
                                <span class="metric-value" id="campaign-people">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Cost per Person</span>
                                <span class="metric-value" id="campaign-cpp">--</span>
                            </div>
                        </div>

                        <!-- Posts Section -->
                        <div class="detail-section" style="margin-top: var(--space-2xl);">
                            <h3 class="section-title">Campaign Posts</h3>
                            <ul class="simple-list" id="campaign-posts-list">
                                <li class="text-muted">No posts in this campaign</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div>
                        <!-- Performance Section -->
                        <div class="detail-section">
                            <h3 class="section-title">Performance</h3>
                            <div class="metric-row">
                                <span class="metric-label">Total Impressions</span>
                                <span class="metric-value" id="campaign-impressions">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Total Clicks</span>
                                <span class="metric-value" id="campaign-clicks">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">CTR</span>
                                <span class="metric-value" id="campaign-ctr">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Engagement Rate</span>
                                <span class="metric-value" id="campaign-engagement-rate">--</span>
                            </div>
                        </div>

                        <!-- Actions Section -->
                        <div class="detail-section" style="margin-top: var(--space-2xl);">
                            <h3 class="section-title">Actions</h3>
                            <div style="display: flex; flex-direction: column; gap: var(--space-md);">
                                <button class="btn" onclick="editCampaign()">
                                    <i class="fas fa-edit"></i>
                                    Edit Campaign
                                </button>
                                <button class="btn" onclick="viewAnalytics()">
                                    <i class="fas fa-chart-line"></i>
                                    View Analytics
                                </button>
                                <button class="btn" onclick="exportReport()">
                                    <i class="fas fa-download"></i>
                                    Export Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/config.js"></script>
    <script>
        let currentCampaign = null;
        let supabase;

        // Initialize Supabase
        function initSupabase() {
            if (typeof window.supabase !== 'undefined' && SUPABASE_CONFIG) {
                supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                return true;
            }
            return false;
        }

        // Get campaign ID from URL
        function getCampaignId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        // Load campaign details
        async function loadCampaignDetails() {
            const campaignId = getCampaignId();
            if (!campaignId) {
                showError('No campaign ID provided');
                return;
            }

            if (!supabase) {
                console.error('Supabase not initialized');
                showError('Unable to load campaign data');
                return;
            }

            try {
                // Load campaign data
                const { data: campaign, error } = await supabase
                    .from('campaign_groups')
                    .select(`
                        *,
                        campaign_performance (
                            post_count,
                            person_count,
                            total_acquisition_cost
                        )
                    `)
                    .eq('id', campaignId)
                    .eq('tenant_id', DEFAULT_TENANT_ID)
                    .single();

                if (error) throw error;

                currentCampaign = campaign;
                displayCampaign(campaign);

                // Load campaign posts
                const { data: posts } = await supabase
                    .from('post_campaigns')
                    .select('*, posts(*)')
                    .eq('campaign_group_id', campaignId)
                    .eq('tenant_id', DEFAULT_TENANT_ID);

                displayPosts(posts || []);
            } catch (error) {
                console.error('Error loading campaign:', error);
                showError('Failed to load campaign data');
            }
        }


        // Display campaign details
        function displayCampaign(campaign) {
            // Header
            document.getElementById('campaign-name').textContent = campaign.name;
            document.getElementById('campaign-client').textContent = campaign.client_name || 'No client';
            
            const startDate = campaign.start_date ? new Date(campaign.start_date).toLocaleDateString() : 'Not set';
            const endDate = campaign.end_date ? new Date(campaign.end_date).toLocaleDateString() : 'Ongoing';
            document.getElementById('campaign-dates').textContent = `${startDate} - ${endDate}`;
            
            // Status badge
            const statusEl = document.getElementById('campaign-status');
            statusEl.textContent = campaign.status;
            statusEl.className = `badge ${campaign.status === 'active' ? 'high' : campaign.status === 'paused' ? 'medium' : 'low'}`;

            // Overview
            document.getElementById('campaign-type').textContent = campaign.campaign_type;
            document.getElementById('campaign-budget').textContent = 
                campaign.budget_amount > 0 ? `$${campaign.budget_amount.toLocaleString()}` : 'Organic';

            // Performance
            const perf = campaign.campaign_performance || {};
            document.getElementById('campaign-spend').textContent = 
                perf.total_acquisition_cost > 0 ? `$${perf.total_acquisition_cost.toFixed(2)}` : '$0';
            document.getElementById('campaign-posts').textContent = perf.post_count || 0;
            document.getElementById('campaign-people').textContent = perf.person_count || 0;
            
            const cpp = perf.person_count > 0 
                ? (perf.total_acquisition_cost / perf.person_count).toFixed(2)
                : '0.00';
            document.getElementById('campaign-cpp').textContent = `$${cpp}`;
        }

        // Display posts
        function displayPosts(posts) {
            const list = document.getElementById('campaign-posts-list');
            
            if (posts.length === 0) {
                return;
            }

            list.innerHTML = posts.map(post => `
                <li>
                    <a href="/post-detail.html?id=${post.post_id}" class="link">
                        ${post.posts?.post_title || 'Untitled Post'}
                    </a>
                    <span class="text-muted"> - ${post.posts?.engagement_count || 0} engagements</span>
                </li>
            `).join('');
        }

        // Show error
        function showError(message) {
            document.getElementById('campaign-name').textContent = 'Error';
            document.getElementById('campaign-client').textContent = message;
        }

        // Actions
        function editCampaign() {
            alert('Campaign editing will be implemented soon!');
        }

        function viewAnalytics() {
            alert('Analytics view will be implemented soon!');
        }

        function exportReport() {
            alert('Report export will be implemented soon!');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            let attempts = 0;
            const checkSupabase = setInterval(() => {
                attempts++;
                if (initSupabase()) {
                    clearInterval(checkSupabase);
                    loadCampaignDetails();
                } else if (attempts > 20) {
                    clearInterval(checkSupabase);
                    console.error('Failed to initialize Supabase after 20 attempts');
                    showError('Unable to initialize database connection');
                }
            }, 100);
        });
    </script>
</body>
</html>